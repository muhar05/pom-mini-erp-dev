generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows"]
  engineType    = "binary"
}

datasource db {
  provider = "postgresql"
}

model leads {
  id                             Int       @id @default(autoincrement())
  reference_no                   String?   @db.VarChar(100)
  lead_name                      String    @db.VarChar(150)
  contact                        String?   @db.VarChar(150)
  email                          String?   @db.VarChar(150)
  phone                          String?   @db.VarChar(50)
  type                           String?   @db.VarChar(100)
  company                        String?   @db.VarChar(150)
  location                       String?   @db.VarChar(150)
  product_interest               String?   @db.VarChar(200)
  source                         String?   @db.VarChar(100)
  note                           String?
  id_user                        Int?
  created_at                     DateTime? @default(now()) @db.Timestamp(6)
  assigned_to                    Int?
  status                         String?   @default("Open") @db.VarChar(50)
  potential_value                Decimal?  @default(0) @db.Decimal(18, 2) // <--- Tambahkan field ini
  users_leads_assigned_toTousers users?    @relation("leads_assigned_toTousers", fields: [assigned_to], references: [id])
  users_leads_id_userTousers     users?    @relation("leads_id_userTousers", fields: [id_user], references: [id])
}

model products {
  id           Int       @id @default(autoincrement())
  product_code String    @unique @db.VarChar(100)
  item_group   String?   @db.VarChar(100)
  name         String    @db.VarChar(200)
  unit         String?   @db.VarChar(50)
  part_number  String?   @db.VarChar(150)
  description  String?
  price        Decimal?  @default(0) @db.Decimal(18, 2)
  stock        Int?      @default(0)
  brand        String?   @db.VarChar(100)
  rack         String?   @db.VarChar(100)
  images       Json?
  created_at   DateTime? @default(now()) @db.Timestamp(6)
  updated_at   DateTime? @default(now()) @db.Timestamp(6)
}

model quotations {
  id               Int            @id @default(autoincrement())
  quotation_no     String         @db.VarChar(50)
  customer_id      Int?
  user_id          Int?           // <--- Tambahkan ini
  lead_id          Int?    
  quotation_detail Json
  total            Decimal?       @default(0) @db.Decimal(18, 2)
  shipping         Decimal?       @default(0) @db.Decimal(18, 2)
  discount         Decimal?       @default(0) @db.Decimal(18, 2)
  tax              Decimal?       @default(0) @db.Decimal(18, 2)
  grand_total      Decimal?       @default(0) @db.Decimal(18, 2)
  status           String?        @default("draft") @db.VarChar(50)
  note             String?
  target_date      DateTime?      @db.Date
  created_at       DateTime?      @default(now()) @db.Timestamp(6)
  updated_at       DateTime?      @default(now()) @db.Timestamp(6)
  customer         customers?      @relation(fields: [customer_id], references: [id])
  user             users?         @relation(fields: [user_id], references: [id]) // <--- Relasi ke users
  sales_orders     sales_orders[] @relation("QuotationToSalesOrder")
  payment_term_id  Int?
  revision_no      Int            @default(1)
  payment_term     payment_terms? @relation(fields: [payment_term_id], references: [id])
}

model roles {
  id        Int     @id @default(autoincrement())
  role_name String  @db.VarChar(100)
  users     users[]
}

model user_otp {
  id         Int      @id @default(autoincrement())
  user_id    Int?
  otp_code   String   @db.VarChar(10)
  expires_at DateTime @db.Timestamp(6)
  is_used    Boolean? @default(false)
  users      users?   @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model users {
  id                             Int         @id @default(autoincrement())
  name                           String      @db.VarChar(150)
  email                          String      @unique @db.VarChar(150)
  password_hash                  String
  role_id                        Int?
  created_at                     DateTime?   @default(now()) @db.Timestamp(6)
  leads_leads_assigned_toTousers leads[]     @relation("leads_assigned_toTousers")
  leads_leads_id_userTousers     leads[]     @relation("leads_id_userTousers")
  user_logs                      user_logs[]
  user_otp                       user_otp[]
  roles                          roles?      @relation(fields: [role_id], references: [id])
  quotations                     quotations[]
  sales_orders                   sales_orders[] @relation("UserToSalesOrders") // <-- Tambahkan relasi balik ini
  purchase_orders                purchase_orders[] @relation("UserToPurchaseOrders")
  assigned_purchase_orders       purchase_orders[] @relation("AssignedToPurchaseOrders")
  stock_reservations             stock_reservations[] @relation("UserToStockReservations")
  delivery_requests              delivery_requests[] @relation("UserToDeliveryRequests")
  delivery_orders                delivery_orders[] @relation("UserToDeliveryOrders")
}

model company {
  id            Int            @id @default(autoincrement())
  company_name  String         @db.VarChar(200)
  address       String?
  npwp          String?        @db.VarChar(50)
  id_level      Int?
  note          String?
  created_at    DateTime?      @default(now()) @db.Timestamp(6)
  company_level company_level? @relation(fields: [id_level], references: [id_level], onUpdate: NoAction)
  customers     customers[]
}

model company_level {
  id_level   Int       @id @default(autoincrement())
  level_name String    @db.VarChar(100)
  disc1      Decimal?  @default(0) @db.Decimal(5, 2)
  disc2      Decimal?  @default(0) @db.Decimal(5, 2)
  company    company[]
}

model customers {
  id            Int            @id @default(autoincrement())
  customer_name String         @db.VarChar(200)
  address       String?
  phone         String?        @db.VarChar(50)
  email         String?        @db.VarChar(150)
  type          String?        @db.VarChar(50)
  company_id    Int?
  note          String?
  created_at    DateTime?      @default(now()) @db.Timestamp(6)
  company       company?       @relation(fields: [company_id], references: [id], onUpdate: NoAction)
  quotations    quotations[]
  sales_orders  sales_orders[]
}

model user_logs {
  id         BigInt    @id @default(autoincrement())
  user_id    Int
  activity   String    @db.VarChar(255)
  method     String?   @db.VarChar(10)
  endpoint   String?
  ip_address String?   @db.VarChar(45)
  user_agent String?
  old_data   Json?
  new_data   Json?
  created_at DateTime? @default(now()) @db.Timestamp(6)
  users      users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_user")
}

model warehouse {
  id         Int       @id @default(autoincrement())
  code       String    @unique @db.VarChar(50)
  name       String    @db.VarChar(150)
  location   String?
  created_at DateTime? @default(now()) @db.Timestamp(6)
  updated_at DateTime? @default(now()) @db.Timestamp(6)
}

model delivery_orders {
  id                  BigInt    @id @default(autoincrement())
  do_no               String    @unique @db.VarChar(50)
  delivery_request_id BigInt
  sale_id             BigInt
  status              String?   @default("OPEN") @db.VarChar(30)
  customer_po         String?
  user_id             Int?
  note                String?
  created_at          DateTime? @default(now()) @db.Timestamp(6)
  
  user                users?    @relation("UserToDeliveryOrders", fields: [user_id], references: [id])
}

model delivery_requests {
  id         BigInt    @id @default(autoincrement())
  dr_no      String    @unique @db.VarChar(50)
  sale_id    BigInt
  status     String?   @default("OPEN") @db.VarChar(30)
  user_id    Int?
  note       String?
  created_at DateTime? @default(now()) @db.Timestamp(6)
  
  user       users?    @relation("UserToDeliveryRequests", fields: [user_id], references: [id])
}

model finance_approval {
  id         BigInt    @id @default(autoincrement())
  sale_id    BigInt
  status     String?   @default("PENDING") @db.VarChar(30)
  note       String?
  created_at DateTime? @default(now()) @db.Timestamp(6)
}

model finance_transactions {
  id             BigInt    @id @default(autoincrement())
  sale_id        BigInt
  amount         Decimal   @db.Decimal(15, 2)
  payment_status String?   @default("UNPAID") @db.VarChar(30)
  note           String?
  created_at     DateTime? @default(now()) @db.Timestamp(6)
}

model purchase_orders {
  id              BigInt    @id @default(autoincrement())
  po_no           String    @unique @db.VarChar(50)
  pr_id           BigInt?
  user_id         Int?
  supplier_id     BigInt?
  assigned_to     Int?
  po_detail_items Json
  total           Decimal?  @default(0) @db.Decimal(15, 2)
  status          String?   @default("DRAFT") @db.VarChar(30)
  supplier_do     String?   @db.VarChar(255)
  supplier_so     String?   @db.VarChar(255)
  created_at      DateTime? @default(now()) @db.Timestamp(6)
  
  user            users?    @relation("UserToPurchaseOrders", fields: [user_id], references: [id])
  assigned_user   users?    @relation("AssignedToPurchaseOrders", fields: [assigned_to], references: [id])
  supplier        suppliers? @relation(fields: [supplier_id], references: [id])
}


model sale_order_detail {
  id           BigInt       @id @default(autoincrement())
  sale_id      BigInt
  product_id   BigInt?
  product_name String       @db.VarChar(255)
  price        Decimal      @db.Decimal(15, 2)
  qty          Int
  total        Decimal?     @db.Decimal(15, 2)
  status       String?      @default("ACTIVE") @db.VarChar(30)
  sales_order  sales_orders @relation(fields: [sale_id], references: [id], onDelete: Cascade)
}

model sales_orders {
  id                BigInt              @id @default(autoincrement())
  sale_no           String              @unique @db.VarChar(50)
  quotation_id      Int?
  user_id           Int?                // <-- Tambahkan field ini
  total             Decimal?            @default(0) @db.Decimal(15, 2)
  discount          Decimal?            @default(0) @db.Decimal(15, 2)
  shipping          Decimal?            @default(0) @db.Decimal(15, 2)
  tax               Decimal?            @default(0) @db.Decimal(15, 2)
  grand_total       Decimal?            @default(0) @db.Decimal(15, 2)
  status            String?             @default("DRAFT") @db.VarChar(30)
  note              String?
  sale_status       String?             @default("OPEN") @db.VarChar(30)
  payment_status    String?             @default("UNPAID") @db.VarChar(30)
  file_po_customer  String?
  created_at        DateTime?           @default(now()) @db.Timestamp(6)
  customer_id       Int?
  sale_order_detail sale_order_detail[]
  customers         customers?          @relation(fields: [customer_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  quotation         quotations?         @relation("QuotationToSalesOrder", fields: [quotation_id], references: [id])
  user              users?              @relation("UserToSalesOrders", fields: [user_id], references: [id]) // <-- Tambahkan relasi ini
  payment_term_id  Int?
  payment_term     payment_terms? @relation(fields: [payment_term_id], references: [id])
  revision_no      Int            @default(1)
}

model stock_reservations {
  id          BigInt    @id @default(autoincrement())
  item_detail Json
  lead_id     BigInt?
  type        String?   @db.VarChar(30)
  status      String?    @default("RESERVED") @db.VarChar(30)
  user_id     Int?
  note        String?
  created_at  DateTime? @default(now()) @db.Timestamp(6)
  
  user        users?    @relation("UserToStockReservations", fields: [user_id], references: [id])
}

model suppliers {
  id            BigInt    @id @default(autoincrement())
  supplier_name String    @db.VarChar(255)
  address       String?
  phone         String?   @db.VarChar(30)
  email         String?   @db.VarChar(150)
  type          String?   @db.VarChar(30)
  created_at    DateTime? @default(now()) @db.Timestamp(6)
  purchase_orders purchase_orders[]
}

model warehouses_history {
  id          BigInt    @id @default(autoincrement())
  wh_id       BigInt
  product_id  BigInt
  remark      String?   @db.VarChar(50)
  qty         Int
  part_number String?   @db.VarChar(100)
  supplier_id BigInt?
  po_id       BigInt?
  do_id       BigInt?
  note        String?
  created_at  DateTime? @default(now()) @db.Timestamp(6)
  created_by  BigInt?
}

enum PaymentTerm {
  cash
  net30
  net60
  cod
}

model payment_terms {
  id        Int     @id @default(autoincrement())
  code      String  @unique @db.VarChar(50)
  name      String  @db.VarChar(100)
  days      Int?
  note      String?
  is_active Boolean @default(true)

  quotations   quotations[]
  sales_orders sales_orders[]
}